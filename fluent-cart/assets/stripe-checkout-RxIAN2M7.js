class Y{constructor(l,u,f){this.form=l,this.data=u,this.paymentArgs=u.payment_args,this.intent=u.intent,this.paymentLoader=f,this.$t=this.translate.bind(this)}translate(l){var f;return(((f=window.fct_stripe_data)==null?void 0:f.translations)||{})[l]||l}async init(){var x,L;const l=document.querySelector("[data-fluent-cart-checkout-page-checkout-button]"),u=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe"),f=this.form.querySelector(".fluent_cart_payment_methods");f&&(f.style.display="none");const o=this,t=Stripe((x=this.paymentArgs)==null?void 0:x.public_key),i=await t.elements(this.intent),p={fields:{billingDetails:{name:"never",email:"never"}}},s=await i.create("payment",p);s.mount(".fluent-cart-checkout_embed_payment_container_stripe");const r=(L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button;s.on("loaderror",function(a){var g,e,k;const _=document.getElementById("fct_loading_payment_processor");_&&_.remove();let d=(g=a==null?void 0:a.error)==null?void 0:g.message,y="";if(((e=window==null?void 0:window.fluentcart_checkout_info)==null?void 0:e.is_admin)!=="1"){d=o.$t("Payment module not available to checkout! Please reload again, or contact admin!"),y=`<p style="color:red; display:none;" class="hidden-error">${(k=a==null?void 0:a.error)==null?void 0:k.message}</p>`;const w=document.createElement("a");w.className="toggle-error",w.style.cursor="pointer",w.textContent=o.$t("See Errors"),w.addEventListener("click",function(){document.querySelector(".hidden-error").style.display=document.querySelector(".hidden-error").style.display==="none"?"block":"none"}),u.prepend(w)}const n=document.createElement("p");n.style.color="red",n.innerHTML=d+y,u.prepend(n),window.is_stripe_ready=!1,o.paymentLoader.disableCheckoutButton(r==null?void 0:r.text)}),s.on("ready",function(a){const _=document.getElementById("fct_loading_payment_processor");if(_&&_.remove(),l&&l.id==="fluent_cart_custom_checkout_btn")o.paymentLoader.disableCheckoutButton(o.$t("Pay Now"));else{const d=o.form.querySelector('input[name="_fct_pay_method"]:checked');d&&d.value==="stripe"&&o.paymentLoader.disableCheckoutButton(r.text)}window.is_stripe_ready=!1,s.addEventListener("change",function(d){window.is_stripe_ready=d.complete,document.querySelectorAll(".fc-error-message").forEach(n=>n.remove()),window.is_stripe_ready?l&&l.id==="fluent_cart_custom_checkout_btn"?o.paymentLoader.enableCheckoutButton(o.$t("Pay Now")):o.paymentLoader.enableCheckoutButton(r.text):o.paymentLoader.disableCheckoutButton(r!=null&&r.text?r.text:o.$t("Place Order"))}),window.addEventListener("fluent_cart_payment_next_action_stripe",d=>{var M,T,$,I,N,B,A,O,U,j,D;(M=o.paymentLoader)==null||M.changeLoaderStatus("processing");const y=document.querySelector(".fc-loader");(T=y==null?void 0:y.classList)==null||T.add("active");const n=($=d.detail)==null?void 0:$.response;let g=(I=n==null?void 0:n.payment_args)==null?void 0:I.success_url;(N=n==null?void 0:n.payment_args)==null||N.custom_payment_url;const e=n==null?void 0:n.fc_customer;let k=null,w="intent";((B=n==null?void 0:n.response)==null?void 0:B.object)==="subscription"?(w=(O=(A=n==null?void 0:n.payment_args)==null?void 0:A.vendor_subscription_info)==null?void 0:O.type,k=(j=(U=n==null?void 0:n.payment_args)==null?void 0:U.vendor_subscription_info)==null?void 0:j.clientSecret):k=(D=n==null?void 0:n.response)==null?void 0:D.client_secret;const F=function(q){new Toastify({text:q,className:"warning",duration:2e3,escapeMarkup:!1,close:!0}).showToast()};i.submit().then(q=>{const S=w==="setup"?t.confirmSetup:t.confirmPayment,v=w==="setup"?"setupIntent":"paymentIntent",G={elements:i,clientSecret:k,confirmParams:{return_url:g,payment_method_data:{billing_details:{address:{city:e!=null&&e.city?e==null?void 0:e.city:null,country:e!=null&&e.country?e==null?void 0:e.country:null,postal_code:e!=null&&e.postcode?e==null?void 0:e.postcode:null,state:e!=null&&e.state?e==null?void 0:e.state:null,line1:e!=null&&e.address_1?e==null?void 0:e.address_1:null},name:(e==null?void 0:e.first_name)+" "+(e==null?void 0:e.last_name),email:e==null?void 0:e.email}}},redirect:"if_required"};S(G).then(m=>{var H,Q,J,X,W;(H=o.paymentLoader)==null||H.changeLoaderStatus("confirming"),m!=null&&m.error&&(console.log("inside error",(Q=m==null?void 0:m.error)==null?void 0:Q.message),o.paymentLoader.enableCheckoutButton(r.text),F((J=m==null?void 0:m.error)==null?void 0:J.message),(X=o.paymentLoader)==null||X.hideLoader());const c=m[v];if(c!=null&&c.status&&(c.status==="succeeded"||c.status==="processing"||c.status==="requires_capture")){(W=o.paymentLoader)==null||W.changeLoaderStatus("completed");const K=new URLSearchParams(window.location.search).get("mode")||"order",V=new URLSearchParams({action:"fluent_cart_confirm_stripe_payment",intentId:c.id,mode:K}).toString(),h=new XMLHttpRequest;h.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),h.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){var z;if(h.readyState===4)if(h.status>=200&&h.status<300){(z=o.paymentLoader)==null||z.changeLoaderStatus("redirecting");let E=JSON.parse(h.responseText);E&&(o.paymentLoader.triggerPaymentCompleteEvent(E),E.redirect_url&&(g=E.redirect_url)),window.location.href=g}else console.log(h.responseText,"failed")},h.onerror=function(){console.log("Request failed")},h.send(V)}else if((c==null?void 0:c.status)==="requires_action"||(c==null?void 0:c.status)==="requires_source_action")return P(c)})}).catch(q=>{var S,v;console.log(q,"failed"),y.classList.remove("active"),(S=o.paymentLoader)==null||S.changeLoaderStatus("failed"),(v=o.paymentLoader)==null||v.hideLoader()})})});const P=a=>{var d,y;(d=o.paymentLoader)==null||d.changeLoaderStatus(o.$t("redirecting for action"));const _=(y=a.next_action)==null?void 0:y.type;switch(_){case"redirect_to_url":window.location.href=a.next_action.redirect_to_url.url;break;case"cashapp_handle_redirect_or_display_qr_code":a.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.cashapp_handle_redirect_or_display_qr_code.qr_code);break;case"display_boleto":window.location.href=a.next_action.boleto_display_details.hosted_voucher_url;break;case"oxxo_display_details":window.location.href=a.next_action.oxxo_display_details.hosted_voucher_url;break;case"alipay_handle_redirect":window.location.href=a.next_action.alipay_handle_redirect.url;break;case"konbini_display_details":window.location.href=a.next_action.konbini_display_details.hosted_voucher_url;break;case"display_bank_transfer_instructions":window.location.href=a.next_action.display_bank_transfer_instructions.hosted_instructions_url;break;case"verify_with_microdeposits":window.location.href=a.next_action.verify_with_microdeposits.hosted_verification_url;break;case"wechat_pay_display_qr_code":a.next_action.wechat_pay_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.wechat_pay_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.wechat_pay_display_qr_code.qr_code);break;case"promptpay_display_qr_code":a.next_action.promptpay_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.promptpay_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.promptpay_display_qr_code.qr_code);break;default:console.error("Unsupported next_action type:",_);break}};window.addEventListener("fluent_cart_validate_checkout_stripe",function(a){if(!window.is_stripe_ready){const _=document.createElement("div");_.className="fc-error-message",_.textContent=o.$t("Card details are not valid!"),document.querySelector(".fluent-cart-checkout-page-checkout-form-order-summary").appendChild(_),t.confirmPayment({elements:i,confirmParams:{return_url:"https://stripe.com"},redirect:"if_required"})}})}}window.addEventListener("fluent_cart_load_payments_stripe",function(b){window.fluentcart.$t;const l=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe");o(),f(),fetch(b.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":b.detail.nonce},credentials:"include"}).then(async t=>{var p,s,r;if(t=await t.json(),(t==null?void 0:t.status)==="failed"&&u(t==null?void 0:t.message),((p=t==null?void 0:t.intent)==null?void 0:p.amount)<=0&&((s=t==null?void 0:t.intent)==null?void 0:s.mode)!=="subscription"){let x=function(a){return P[a]||a};var i=x;const P=((r=window.fct_stripe_data)==null?void 0:r.translations)||{};u(x("Total amount is not valid, please add some items to cart!"));const L=document.getElementById("fct_loading_payment_processor");L&&L.remove();return}new Y(b.detail.form,t,b.detail.paymentLoader).init()}).catch(t=>{var s;const i=((s=window.fct_stripe_data)==null?void 0:s.translations)||{};function p(r){return i[r]||r}u(p("An error occurred while parsing the response."))});function u(t){if(!t)return;const i=document.createElement("div");i.className="fc-error-message",i.textContent=t,l.appendChild(i);const p=document.getElementById("fct_loading_payment_processor");p&&p.remove()}function f(){var s;const t=document.createElement("p");t.id="fct_loading_payment_processor";const i=((s=window.fct_stripe_data)==null?void 0:s.translations)||{};function p(r){return i[r]||r}t.textContent=p("Loading Payment Processor..."),l.appendChild(t)}function o(){document.querySelectorAll(".fc-error-message").forEach(i=>i.remove())}});
